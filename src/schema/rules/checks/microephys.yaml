---
# Microelectrode electrophysiology validation rules

# Override the general RequiredCoordsystem rule for microephys
# Allow electrodes.tsv without coordsystem.json for microephys datatypes
RequiredCoordsystem:
  issue:
    code: REQUIRED_COORDSYSTEM
    message: |
      If an electrodes.tsv file is provided, an associated coordsystem.json must also be present.
    level: error
  selectors:
    - suffix == "electrodes"
    - extension == ".tsv"
    - '!intersects([datatype], ["ecephys", "icephys"])'  # Exclude microephys datatypes
  checks:
    - associations.coordsystem != null

# For microephys: if coordsystem.json with space exists, require matching electrodes.tsv
RequiredElectrodesWithSpace:
  issue:
    code: MICROEPHYS_ELECTRODES_SPACE_REQUIRED
    message: |
      If a coordsystem.json file with a space entity is present for microelectrode
      electrophysiology data, a corresponding electrodes.tsv file with the same
      space entity must also be present.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "coordsystem"
    - extension == ".json"
    - '"space" in entities'
  checks:
    - associations.electrodes != null

# Ensure space labels match between coordsystem.json and electrodes.tsv
MatchingSpaceLabels:
  issue:
    code: MICROEPHYS_SPACE_MISMATCH
    message: |
      The space entity in electrodes.tsv must match the space entity in the
      corresponding coordsystem.json file for microelectrode electrophysiology data.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "electrodes"
    - extension == ".tsv"
    - '"space" in entities'
    - associations.coordsystem != null
  checks:
    - associations.coordsystem.entities.space == entities.space
