---
# Microelectrode electrophysiology validation rules

# Override the general RequiredCoordsystem rule for microephys
# Allow electrodes.tsv without coordsystem.json for microephys datatypes
RequiredCoordsystem:
  issue:
    code: REQUIRED_COORDSYSTEM
    message: |
      If an electrodes.tsv file is provided, an associated coordsystem.json must also be present.
    level: error
  selectors:
    - suffix == "electrodes"
    - extension == ".tsv"
    - '!intersects([datatype], ["ecephys", "icephys"])'  # Exclude microephys datatypes
  checks:
    - associations.coordsystem != null

# For microephys: if coordsystem.json with space exists, require matching electrodes.tsv
RequiredElectrodesWithSpace:
  issue:
    code: MICROEPHYS_ELECTRODES_SPACE_REQUIRED
    message: |
      If a coordsystem.json file with a space entity is present for microelectrode
      electrophysiology data, a corresponding electrodes.tsv file with the same
      space entity must also be present.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "coordsystem"
    - extension == ".json"
    - '"space" in entities'
  checks:
    - associations.electrodes != null

# Ensure space labels match between coordsystem.json and electrodes.tsv
MatchingSpaceLabels:
  issue:
    code: MICROEPHYS_SPACE_MISMATCH
    message: |
      The space entity in electrodes.tsv must match the space entity in the
      corresponding coordsystem.json file for microelectrode electrophysiology data.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "electrodes"
    - extension == ".tsv"
    - '"space" in entities'
    - associations.coordsystem != null
  checks:
    - associations.coordsystem.entities.space == entities.space

# Validate electrode-probe relationship
# All probe_name values in electrodes.tsv must reference valid entries in probes.tsv
ElectrodeProbeReference:
  issue:
    code: MICROEPHYS_ELECTRODE_PROBE_INVALID
    message: |
      The probe_name column in electrodes.tsv must reference valid probe names
      defined in the associated probes.tsv file. Each electrode must be associated
      with an existing probe.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "electrodes"
    - extension == ".tsv"
    - columns.probe_name != null
    - associations.probes != null
    - associations.probes.probe_name != null
  checks:
    - |
      length(intersects(unique(columns.probe_name), associations.probes.probe_name))
      == length(unique(columns.probe_name))

# Ensure probes.tsv exists when electrodes.tsv is present
RequiredProbesFile:
  issue:
    code: MICROEPHYS_PROBES_REQUIRED
    message: |
      For microelectrode electrophysiology data, if an electrodes.tsv file is present,
      an associated probes.tsv file must also be present to define the probes
      referenced by the electrodes.
    level: error
  selectors:
    - intersects([datatype], ["ecephys", "icephys"])
    - suffix == "electrodes"
    - extension == ".tsv"
    - columns.probe_name != null
  checks:
    - associations.probes != null
