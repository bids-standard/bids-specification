#
# Groups of related metadata fields
#
# Assumptions: never need disjunction of selectors
# Assumptions: top-to-bottom overrides is sufficient logic


---
# PET common metadata fields
PETScannerHardware:
    selectors:
    - modality == "PET"
    fields:
        Manufacturer:
            level: REQUIRED
            addendum: Corresponds to DICOM Tag 0008, 0070 `Manufacturer`.
        ManufacturersModelName:
            level: REQUIRED
            addendum: Corresponds to DICOM Tag 0008, 1090 `Manufacturers Model Name`.
        Units:
            level: REQUIRED
            addendum: |
                SI unit for radioactivity (Becquerel) should be used (for example, "Bq/mL").
                Corresponds to DICOM Tag 0054, 1001 `Units`.
        InstitutionName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 0080 `InstitutionName`.
        InstitutionAddress:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 0081 `InstitutionAddress`.
        InstitutionalDepartmentName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 1040 `Institutional Department Name`.
        BodyPart:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0018, 0015 `Body Part Examined`.

PETRadioChemistry:
    selectors:
    - modality == "PET"
    fields:
        TracerName:
            level: REQUIRED
        TracerRadionuclide:
            level: REQUIRED
        InjectedRadioactivity:
            level: REQUIRED
        InjectedRadioactivityUnits:
            level: REQUIRED
        InjectedMass:
            level: REQUIRED
        InjectedMassUnits:
            level: REQUIRED
        SpecificRadioactivity:
            level: REQUIRED
        SpecificRadioactivityUnits:
            level: REQUIRED
        ModeOfAdministration:
            level: REQUIRED
        TracerRadLex:
            level: RECOMMENDED
        TracerSNOMED:
            level: RECOMMENDED
        TracerMolecularWeight:
            level: RECOMMENDED
        TracerMolecularWeightUnits:
            level: RECOMMENDED
        InjectedMassPerWeight:
            level: RECOMMENDED
        InjectedMassPerWeightUnits:
            level: RECOMMENDED
        SpecificRadioactivityMeasTime:
            level: RECOMMENDED
        MolarActivity:
            level: RECOMMENDED
        MolarActivityUnits:
            level: RECOMMENDED
        MolarActivityMeasTime:
            level: RECOMMENDED
        InfusionRadioactivity:
            level: RECOMMENDED
            level_addendum: REQUIRED if PETRadioChemistry.fields.ModeOfAdministration == 'bolus-infusion'
        InfusionStart:
            level: RECOMMENDED
            level_addendum: REQUIRED if PETRadioChemistry.fields.ModeOfAdministration == 'bolus-infusion'
        InfusionSpeed:
            level: RECOMMENDED
            level_addendum: REQUIRED if PETRadioChemistry.fields.ModeOfAdministration == 'bolus-infusion'
        InfusionSpeedUnits:
            level: RECOMMENDED
            level_addendum: REQUIRED if PETRadioChemistry.fields.ModeOfAdministration == 'bolus-infusion'
        InjectedVolume:
            level: RECOMMENDED
            level_addendum: REQUIRED if PETRadioChemistry.fields.ModeOfAdministration == 'bolus-infusion'
        Purity:
            level: RECOMMENDED

# PET Infusion conditionally REQUIRED entities
EntitiesBolusMetadata:
    selectors:
    - modality == 'PET'
    - sidecar.ModeOfAdministration == 'bolus-infusion'
    fields:
        InfusionRadioactivity:
            level: REQUIRED
        InfusionStart:
            level: REQUIRED
        InfusionSpeed:
            level: REQUIRED
        InfusionSpeedUnits:
            level: REQUIRED
        InjectedVolume:
            level: REQUIRED

PETPharmaceuticals:
    selectors:
    - modality == "PET"
    fields:
        PharmaceuticalName:
            level: RECOMMENDED
        PharmaceuticalDoseAmount:
            level: RECOMMENDED
        PharmaCeuticalDoseUnits:
            level: RECOMMENDED
        PharmaCeuticalDoseRegimen:
            level: RECOMMENDED
        PharmaCeuticalDoseTime:
            level: RECOMMENDED
        Anaesthesia:
            level: OPTIONAL

PETTime:
    selectors:
    - modality == "PET"
    fields:
        TimeZero:
            level: REQUIRED
        ScanStart:
            level: REQUIRED
        InjectionStart:
            level: REQUIRED
        FramesTimesStart:
            level: REQUIRED
        FrameDuration:
            level: REQUIRED
        InjectionEnd:
            level: RECOMMENDED
        ScanDate:
            level: DEPRECATED

PETReconstruction:
    selectors:
    - modality == "PET"
    fields:
        AcquisitionMode:
            level: REQUIRED
        ImageDecayCorrected:
            level: REQUIRED
        ImageDecayCorrectionTime:
            level: REQUIRED
        ReconMethodName:
            level: REQUIRED
        ReconMethodParameterLabels:
            level: REQUIRED
        ReconMethodParameterUnits:
            level: REQUIRED
        ReconMethodParameterValues:
            level: REQUIRED
        ReconFilterType:
            level: REQUIRED
        ReconFilterSize:
            level: REQUIRED
        AttenuationCorrection:
            level: REQUIRED
        ReconMethodImplementationVersion:
            level: RECOMMENDED
        AttenuationCorrectionMethodReference:
            level: RECOMMENDED
        ScaleFactor:
            level: RECOMMENDED
        ScatterFraction:
            level: RECOMMENDED
        DecayCorrectionFactor:
            level: RECOMMENDED
        DoseCalibrationFactor:
            level: RECOMMENDED
        PromptRate:
            level: RECOMMENDED
        SinglesRate:
            level: RECOMMENDED

# MRI Common metadata fields
MRIScannerHardware:
    selectors:
    - modality == "MRI"
    fields:
        Manufacturer:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 0070 `Manufacturer`.
        ManufacturersModelName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 1090 `Manufacturers Model Name`.
        DeviceSerialNumber:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0018, 1000 `DeviceSerialNumber`.
        StationName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 1010 `Station Name`.
        SoftwareVersions:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0018, 1020 `Software Versions`.
        HardcopyDeviceSoftwareVersion: DEPRECATED
        MagneticFieldStrength:
            level: RECOMMENDED, but REQUIRED for Arterial Spin Labeling
        ReceiveCoilName: RECOMMENDED
        ReceiveCoilActiveElements: RECOMMENDED
        GradientSetType: RECOMMENDED
        MRTransmitCoilSequence: RECOMMENDED
        MatrixCoilMode: RECOMMENDED
        CoilCombinationMethod: RECOMMENDED

MRISequenceSpecifics:
    selectors:
    - modality == "MRI"
    fields:
        PulseSequenceType: RECOMMENDED
        ScanningSequence: RECOMMENDED
        SequenceVariant: RECOMMENDED
        ScanOptions: RECOMMENDED
        SequenceName: RECOMMENDED
        PulseSequenceDetails: RECOMMENDED
        NonlinearGradientCorrection: |
            RECOMMENDED, but REQUIRED if [PET](./09-positron-emission-tomography.md)
            data are present
        MRAcquisitionType: RECOMMENDED, but REQUIRED for Arterial Spin Labeling
        MTState: RECOMMENDED
        MTOffsetFrequency: OPTIONAL
        MTPulseBandwidth: OPTIONAL
        MTNumberOfPulses: OPTIONAL
        MTPulseShape: OPTIONAL
        MTPulseDuration: OPTIONAL
        SpoilingState: RECOMMENDED
        SpoilingType: OPTIONAL
        SpoilingRFPhaseIncrement: OPTIONAL
        SpoilingGradientMoment: OPTIONAL
        SpoilingGradientDuration: OPTIONAL

PETMRISequenceSpecifics:
    selectors:
    - modality == "MRI"
    - dataset.modalities contains "PET"
    fields:
        NonLinearGradientCorrection: REQUIRED

ASLMRISequenceSpecifics:
    selectors:
    - modality == "MRI"
    - datatype == "perf"
    fields:
        MRAcquisitionType: REQUIRED

MTParameters:
    selectors:
    - sidecar.MTState == True
    fields:
        MTOffsetFrequency: RECOMMENDED
        MTPulseBandwidth: RECOMMENDED
        MTNumberOfPulses: RECOMMENDED
        MTPulseShape: RECOMMENDED
        MTPulseDuration: RECOMMENDED

SpoilingType:
    selectors:
    - sidecar.SpoilingState == True
    fields:
        SpoilingType: RECOMMENDED

SpoilingRF:
    selectors:
    - sidecar.SpoilingType in ["RF", "COMBINED"]
    fields:
        SpoilingRFPhaseIncrement: RECOMMENDED

SpoilingGradient:
    selectors:
    - sidecar.SpoilingType in ["GRADIENT", "COMBINED"]
    fields:
        SpoilingGradientMoment: RECOMMENDED
        SpoilingGradientDuration: RECOMMENDED

MRISpatialEncoding:
    selectors:
    - modality == "MRI"
    fields:
        NumberShots: RECOMMENDED
        ParallelReductionFactorInPlane: RECOMMENDED
        ParallelAcquisitionTechnique: RECOMMENDED
        PartialFourier: RECOMMENDED
        PartialFourierDirection: RECOMMENDED
        PhaseEncodingDirection:
            level: RECOMMENDED
            level_addendum: |
                This parameter is REQUIRED if corresponding fieldmap data is present
                or when using multiple runs with different phase encoding directions
                (which can be later used for field inhomogeneity correction).
        EffectiveEchoSpacing:
            level: RECOMMENDED
            level_addendum: |
                <sup>2</sup> This parameter is REQUIRED if corresponding fieldmap data
                is present.
        TotalReadoutTime:
            level: RECOMMENDED
            level_addendum: |
                <sup>3</sup> This parameter is REQUIRED if corresponding 'field/distortion' maps
                acquired with opposing phase encoding directions are present
                (see [Case 4: Multiple phase encoded
                directions](#case-4-multiple-phase-encoded-directions-pepolar)).
        MixingTime: RECOMMENDED

MRITimingParameters:
    selectors:
    - modality == "MRI"
    fields:
        EchoTime:
            level: RECOMMENDED
            level_addendum: |
                REQUIRED if corresponding fieldmap data is present,
                or the data comes from a multi-echo sequence or Arterial Spin Labeling.
        InversionTime: RECOMMENDED
        SliceTiming:
            level: RECOMMENDED
            level_addendum: |
                REQUIRED for sparse sequences that do not have the `DelayTime` field set,
                and Arterial Spin Labeling with `MRAcquisitionType` set on `2D`.
        SliceEncodingDirection: RECOMMENDED
        DwellTime: RECOMMENDED

SliceTimingASL:
    selectors:
    - modality == "MRI"
    - datatype == "perf"
    - suffix in ["asl", "m0scan"]
    - sidecar.MRAcquisitionType == "2D"
    fields:
        SliceTiming: REQUIRED

# This is technically for sparse sequences only, but I don't know how to encode that.
SliceTimingSparse:
    selectors:
    - modality == "MRI"
    - sidecar contains "DelayTime"
    fields:
        SliceTiming: REQUIRED

MRIRFandContrast:
    selectors:
    - modality == "MRI"
    fields:
        FlipAngle:
            level: RECOMMENDED
            level_addendum: REQUIRED if LookLocker is set to `true`.
        NegativeContrast: OPTIONAL

MRIFlipAngleLookLocker:
    selectors:
    - modality == "MRI"
    - sidecar.LookLocker == True
    fields:
        FlipAngle: REQUIRED

MRISliceAcceleration:
    selectors:
    - modality == "MRI"
    fields:
        MultibandAccelerationFactor: RECOMMENDED

MRIAnatomicalLandmarks:
    selectors:
    - modality == "MRI"
    fields:
        AnatomicalLandmarkCoordinates__mri: RECOMMENDED

MRIEchoPlanarImagingAndB0Mapping:
    selectors:
    - modality == "MRI"
    fields:
        B0FieldIdentifier: RECOMMENDED
        B0FieldSource: RECOMMENDED

MRIInstitutionInformation:
    selectors:
    - modality == "MRI"
    fields:
        InstitutionName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 0080 `InstitutionName`.
        InstitutionAddress:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 0081 `InstitutionAddress`.
        InstitutionalDepartmentName:
            level: RECOMMENDED
            addendum: Corresponds to DICOM Tag 0008, 1040 `Institutional Department Name`.

# Anatomy imaging data

MRIAnatomyCommonMetadataFields:
    selectors:
    - modality == "MRI"
    - datatype == "anat"
    fields:
        ContrastBolusIngredient: OPTIONAL
        RepetitionTimeExcitation: OPTIONAL
        RepetitionTimePreparation: OPTIONAL

# Entities

EntitiesTaskMetadata:
    selectors:
    - entities contains "task"
    fields:
        TaskName: RECOMMENDED

EntitiesCeMetadata:
    selectors:
    - entities contains "ce"
    fields:
        ContrastBolusIngredient: OPTIONAL

EntitiesTrcMetadata:
    selectors:
    - entities contains "trc"
    fields:
        TracerName: REQUIRED

EntitiesStainMetadata:
    selectors:
    - entities contains "stain"
    fields:
        SampleStaining: RECOMMENDED
        SamplePrimaryAntibodies: RECOMMENDED
        SampleSecondaryAntibodies: RECOMMENDED

EntitiesEchoMetadata:
    selectors:
    - entities contains "echo"
    fields:
        EchoTime: REQUIRED

EntitiesFlipMetadata:
    selectors:
    - entities contains "flip"
    fields:
        FlipAngle: REQUIRED

EntitiesInvMetadata:
    selectors:
    - entities contains "inv"
    fields:
        InversionTime: REQUIRED

EntitiesMTMetadata:
    selectors:
    - entities contains "mt"
    fields:
        MTState: REQUIRED

EntitiesPartMetadata:
    selectors:
    - entities.part == "phase"
    fields:
        Units:
            level: REQUIRED
            rules:
            - value in ["rad", "arbitrary"]

EntitiesResMetadata:
    selectors:
    - entities contains "res"
    fields:
        Resolution: REQUIRED

EntitiesDenMetadata:
    selectors:
    - entities contains "den"
    fields:
        Density: REQUIRED
